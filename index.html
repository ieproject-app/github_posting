<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leap-Day Post Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Markdown parser for preview -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body class="bg-gray-50 p-6">
  <div class="max-w-3xl mx-auto bg-white p-8 rounded-2xl shadow-lg">
    <h1 class="text-2xl font-bold mb-6">Leap-Day Theme Post Generator</h1>
    <form id="post-form" class="space-y-4" autocomplete="off">
      <div>
        <label class="block font-medium">Title</label>
        <input type="text" id="title" class="w-full border rounded p-2" placeholder="Masukkan judul postingan" required autofocus />
      </div>
      <div>
        <label class="block font-medium">Date</label>
        <input type="date" id="date" class="w-full border rounded p-2" required />
      </div>
      <div>
        <label class="block font-medium">Permalink (opsional)</label>
        <input type="text" id="permalink" class="w-full border rounded p-2" placeholder="/kategori/slug/ atau kosongkan untuk default" />
      </div>
      <div>
        <label class="block font-medium">Description</label>
        <textarea id="description" rows="2" class="w-full border rounded p-2" placeholder="Deskripsi singkat..." required></textarea>
      </div>
      <div>
        <label class="inline-flex items-center">
          <input type="checkbox" id="show_downloads" class="form-checkbox" />
          <span class="ml-2">Show Downloads</span>
        </label>
      </div>
      <div>
        <label class="block font-medium">Google Analytics ID</label>
        <input type="text" id="ga_id" class="w-full border rounded p-2" placeholder="UA-XXXXX-Y" />
      </div>
      <div>
        <label class="block font-medium">Tags (pisahkan dengan koma)</label>
        <input type="text" id="tags" class="w-full border rounded p-2" placeholder="jekyll, leap-day, tutorial" />
      </div>
      <!-- Insert Image Tool -->
      <div>
        <label class="block font-medium">Insert Image</label>
        <div class="flex gap-2 mb-2">
          <input type="text" id="img-url" class="w-full border rounded p-2" placeholder="https://... atau /assets/img/myimg.png" />
          <input type="text" id="img-alt" class="w-1/3 border rounded p-2" placeholder="Alt text" />
          <button type="button" id="insert-img-btn" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700">Insert</button>
        </div>
        <small class="text-gray-500">Masukkan URL gambar atau path lokal (misal: /assets/img/...).</small>
      </div>
      <!-- Formatting Tools -->
      <div>
        <label class="block font-medium mb-1">Formatting Tools</label>
        <div class="flex flex-wrap gap-2 mb-2">
          <button type="button" class="fmt-btn bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-xs" data-fmt="h1">H1</button>
          <button type="button" class="fmt-btn bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-xs" data-fmt="h2">H2</button>
          <button type="button" class="fmt-btn bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-xs" data-fmt="h3">H3</button>
          <button type="button" class="fmt-btn bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-xs" data-fmt="bold">Bold</button>
          <button type="button" class="fmt-btn bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-xs" data-fmt="italic">Italic</button>
          <button type="button" class="fmt-btn bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-xs" data-fmt="ulist">List</button>
          <button type="button" class="fmt-btn bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-xs" data-fmt="olist">Numbered</button>
          <button type="button" class="fmt-btn bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-xs" data-fmt="code">Code</button>
          <button type="button" class="fmt-btn bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-xs" data-fmt="quote">Quote</button>
          <button type="button" class="fmt-btn bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-xs" data-fmt="hr">HR</button>
          <button type="button" class="fmt-btn bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded text-xs" data-fmt="link">Link</button>
        </div>
        <small class="text-gray-500">Klik tombol untuk memasukkan format markdown di posisi kursor.</small>
      </div>
      <div>
        <label class="block font-medium">Content</label>
        <textarea id="content" rows="8" class="w-full border rounded p-2 font-mono" placeholder="Tulis konten postingan di sini..."></textarea>
      </div>
      <div class="flex gap-2">
        <button type="button" id="generate-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Generate Markdown & Filename</button>
        <button type="reset" class="bg-gray-200 text-gray-600 px-4 py-2 rounded hover:bg-gray-300">Reset</button>
      </div>
    </form>

    <div class="mt-6 space-y-4">
      <div>
        <label class="block font-medium">Suggested File Path</label>
        <div class="flex items-center gap-2">
          <input type="text" id="filename" class="w-full border rounded p-2 font-mono text-sm bg-gray-100" readonly />
          <button onclick="copyToClipboard('filename')" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300" title="Copy">ðŸ“‹</button>
        </div>
      </div>
      <div>
        <label class="block font-medium">Permalink Preview</label>
        <input type="text" id="permalink-preview" class="w-full border rounded p-2 font-mono text-sm bg-gray-100" readonly />
      </div>
      <div>
        <label class="block font-medium mb-2">Hasil Front Matter & Content</label>
        <div class="flex gap-2">
          <textarea id="output" rows="12" class="w-full border rounded p-2 font-mono text-sm" readonly></textarea>
          <button onclick="copyToClipboard('output')" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300" title="Copy">ðŸ“‹</button>
        </div>
      </div>
      <div>
        <label class="block font-medium mb-2">Markdown Preview</label>
        <div id="preview-content" class="prose bg-gray-50 p-4 rounded overflow-x-auto"></div>
      </div>
    </div>
    <div id="toast" class="fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg z-50 hidden"></div>
  </div>

  <script>
    // Autofill date
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('date').value = new Date().toISOString().substr(0, 10);
      document.getElementById('title').focus();
    });

    // Slugify function (support unicode, dash, trim)
    function slugify(str) {
      return str.toString().toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove accents
        .replace(/[^a-z0-9\s-]/g, '') // Remove non-word
        .replace(/\s+/g, '-')         // Replace space with -
        .replace(/-+/g, '-')          // Replace multiple - with single -
        .replace(/^-+|-+$/g, '');     // Trim - from start/end
    }

    function copyToClipboard(id) {
      const el = document.getElementById(id);
      el.select();
      el.setSelectionRange(0, 99999);
      document.execCommand("copy");
      showToast("Copied!");
    }

    function showToast(msg) {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 1200);
    }

    function generateFrontMatter(data) {
      let fm = `---\n`;
      fm += `title: \"${data.title}\"\n`;
      fm += `description: \"${data.description.replace(/\n/g, ' ')}\"\n`;
      fm += `date: ${data.date}\n`;
      if (data.permalinkInput) fm += `permalink: ${data.permalink}\n`;
      fm += `show_downloads: ${data.showDownloads}\n`;
      if (data.gaId) fm += `google_analytics: ${data.gaId}\n`;
      if (data.tags.length) fm += `tags: [${data.tags.map(t => `\"${t}\"`).join(', ')}]\n`;
      fm += `---\n\n`;
      fm += data.content;
      return fm;
    }

    function autoPermalink(input, slug) {
      let val = input || `/${slug}/`;
      if (!val.startsWith('/')) val = '/' + val;
      if (!val.endsWith('/')) val += '/';
      return val;
    }

    function saveDraft(fields) {
      localStorage.setItem('leapDayDraft', JSON.stringify(fields));
    }

    function loadDraft() {
      const d = localStorage.getItem('leapDayDraft');
      if (d) {
        const f = JSON.parse(d);
        Object.keys(f).forEach(k => {
          if (document.getElementById(k)) {
            if (document.getElementById(k).type === 'checkbox') {
              document.getElementById(k).checked = f[k];
            } else {
              document.getElementById(k).value = f[k];
            }
          }
        });
      }
    }

    // Save draft on input changes
    document.querySelectorAll('#post-form input, #post-form textarea').forEach(el => {
      el.addEventListener('input', () => {
        const fields = {};
        document.querySelectorAll('#post-form input, #post-form textarea').forEach(inp => {
          fields[inp.id] = inp.type === 'checkbox' ? inp.checked : inp.value;
        });
        saveDraft(fields);
      });
    });

    document.getElementById('generate-btn').addEventListener('click', () => {
      // Get values
      const title = document.getElementById('title').value.trim();
      const date = document.getElementById('date').value;
      const permalinkInput = document.getElementById('permalink').value.trim();
      const description = document.getElementById('description').value.trim();
      const showDownloads = document.getElementById('show_downloads').checked;
      const gaId = document.getElementById('ga_id').value.trim();
      const tags = document.getElementById('tags').value.split(',').map(t => t.trim()).filter(Boolean);
      const content = document.getElementById('content').value;

      if (!title || !date || !description) {
        showToast("Field wajib tidak boleh kosong!");
        return;
      }

      const slug = slugify(title);
      if (!slug) {
        showToast("Judul harus menghasilkan slug yang valid!");
        return;
      }

      // Generate file path (DD/MMYYYY/slug.md)
      const [year, month, day] = date.split('-');
      const monthYear = `${month}${year}`;
      const filepath = `${day}/${monthYear}/${slug}.md`;
      document.getElementById('filename').value = filepath;

      // Permalink preview
      const permalink = autoPermalink(permalinkInput, slug);
      document.getElementById('permalink-preview').value = permalink;

      // Generate front matter
      const fm = generateFrontMatter({title, description, date, permalinkInput, permalink, showDownloads, gaId, tags, content});
      document.getElementById('output').value = fm;

      // Markdown preview
      document.getElementById('preview-content').innerHTML = marked.parse(content || '');

      showToast("Generated!");
    });

    // Load local draft if exists
    window.onload = loadDraft;

    // Insert image markdown at cursor in content textarea
    document.getElementById('insert-img-btn').addEventListener('click', () => {
      const url = document.getElementById('img-url').value.trim();
      const alt = document.getElementById('img-alt').value.trim() || "Image";
      if (!url) {
        showToast("URL gambar tidak boleh kosong");
        return;
      }
      const md = `![${alt}](${url})`;
      insertAtCursor('content', md);
      document.getElementById('img-url').value = '';
      document.getElementById('img-alt').value = '';
      document.getElementById('content').focus();
    });

    // Formatting tools
    function insertAtCursor(id, text, selOffset = null) {
      const el = document.getElementById(id);
      const start = el.selectionStart;
      const end = el.selectionEnd;
      const before = el.value.substring(0, start);
      const after = el.value.substring(end);
      el.value = before + text + after;
      el.focus();
      if (selOffset !== null) {
        el.selectionStart = el.selectionEnd = start + selOffset;
      } else {
        el.selectionStart = el.selectionEnd = start + text.length;
      }
      // Update preview
      document.getElementById('preview-content').innerHTML = marked.parse(el.value);
    }

    function getSelectedText(id) {
      const el = document.getElementById(id);
      return el.value.substring(el.selectionStart, el.selectionEnd);
    }

    document.querySelectorAll('.fmt-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const fmt = this.getAttribute('data-fmt');
        let insertText = '';
        let sel = getSelectedText('content');
        let offset = null;
        switch(fmt) {
          case 'h1': insertText = `# ${sel || 'Judul H1'}\n`; offset = sel ? (2+sel.length) : 3; break;
          case 'h2': insertText = `## ${sel || 'Judul H2'}\n`; offset = sel ? (3+sel.length) : 4; break;
          case 'h3': insertText = `### ${sel || 'Judul H3'}\n`; offset = sel ? (4+sel.length) : 5; break;
          case 'bold': insertText = `**${sel || 'tebal'}**`; offset = sel ? (2+sel.length) : 2; break;
          case 'italic': insertText = `*${sel || 'miring'}*`; offset = sel ? (1+sel.length) : 1; break;
          case 'ulist': insertText = `- ${sel || 'item list'}\n`; offset = sel ? (2+sel.length) : 3; break;
          case 'olist': insertText = `1. ${sel || 'item list'}\n`; offset = sel ? (3+sel.length) : 4; break;
          case 'code': insertText = `\`\`\`\n${sel || 'kode'}\n\`\`\`\n`; offset = sel ? (4+sel.length) : 8; break;
          case 'quote': insertText = `> ${sel || 'kutipan'}\n`; offset = sel ? (2+sel.length) : 3; break;
          case 'hr': insertText = `\n---\n`; offset = 5; break;
          case 'link': insertText = `[${sel || 'teks'}](url)`; offset = sel ? (1+sel.length) : 1; break;
        }
        insertAtCursor('content', insertText, offset);
      });
    });

    // Live preview update on typing
    document.getElementById('content').addEventListener('input', () => {
      document.getElementById('preview-content').innerHTML = marked.parse(document.getElementById('content').value);
    });
  </script>
</body>
</html>
